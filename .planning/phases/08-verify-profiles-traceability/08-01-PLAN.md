---
phase: 08-verify-profiles-traceability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/03-profile-system/03-VERIFICATION.md
  - .planning/REQUIREMENTS.md
  - .planning/v1.0-MILESTONE-AUDIT.md
autonomous: true
requirements:
  - PROF-01
  - PROF-02
  - PROF-03
  - PROF-04

must_haves:
  truths:
    - "Phase 3 has a VERIFICATION.md confirming PROF-01 through PROF-04 are satisfied"
    - "REQUIREMENTS.md traceability table shows all 28 requirements as Complete"
    - "REQUIREMENTS.md requirement definition checkboxes for PROF-01..04 are [x]"
    - "Coverage summary reads 28 total, 28 complete, 0 pending"
    - "Milestone audit reflects passed status with 28/28 requirements"
  artifacts:
    - path: ".planning/phases/03-profile-system/03-VERIFICATION.md"
      provides: "Formal verification of Phase 3 Profile System"
      contains: "status: passed"
    - path: ".planning/REQUIREMENTS.md"
      provides: "Complete traceability for all 28 requirements"
      contains: "Complete: 28"
  key_links:
    - from: ".planning/phases/03-profile-system/03-VERIFICATION.md"
      to: "src/crawl4ai_mcp/profiles.py"
      via: "Evidence citations for ProfileManager, build_run_config"
      pattern: "profiles\\.py"
    - from: ".planning/phases/03-profile-system/03-VERIFICATION.md"
      to: ".planning/REQUIREMENTS.md"
      via: "PROF-01..04 requirement IDs referenced in Requirements Coverage table"
      pattern: "PROF-0[1-4]"
---

<objective>
Formally verify Phase 3 (Profile System) and close all traceability gaps so the v1.0 milestone audit passes with 28/28 requirements.

Purpose: The v1.0 milestone audit identified 4 orphaned requirements (PROF-01 through PROF-04) because Phase 3 never received a formal VERIFICATION.md. All code is complete and tested (33 unit tests, 5 downstream consumers). This plan creates the missing verification artifact and updates traceability to close the gap.

Output: `03-VERIFICATION.md` in Phase 3 directory, updated `REQUIREMENTS.md`, updated milestone audit file.
</objective>

<execution_context>
@/Users/brianpotter/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianpotter/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/v1.0-MILESTONE-AUDIT.md

# Phase 3 evidence
@.planning/phases/03-profile-system/03-01-SUMMARY.md
@.planning/phases/03-profile-system/03-02-SUMMARY.md
@.planning/phases/03-profile-system/03-03-SUMMARY.md
@.planning/phases/03-profile-system/03-RESEARCH.md

# Format reference — use the same VERIFICATION.md structure
@.planning/phases/01-foundation/01-VERIFICATION.md

# Source files to verify against
@src/crawl4ai_mcp/profiles.py
@src/crawl4ai_mcp/server.py
@src/crawl4ai_mcp/profiles/default.yaml
@src/crawl4ai_mcp/profiles/fast.yaml
@src/crawl4ai_mcp/profiles/js_heavy.yaml
@src/crawl4ai_mcp/profiles/stealth.yaml
@tests/test_profiles.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 3 VERIFICATION.md with evidence from current codebase</name>
  <files>.planning/phases/03-profile-system/03-VERIFICATION.md</files>
  <action>
Create `.planning/phases/03-profile-system/03-VERIFICATION.md` following the exact format established by the existing VERIFICATION.md files (Phases 1, 2, 4-7). Use the Phase 1 VERIFICATION.md as a structural template.

**Frontmatter:** Set `phase: 03-profile-system`, `status: passed`, `score: 9/9 must-haves verified` (5 observable truths + 4 requirements), `re_verification: false`. Use the terminal `date -u +"%Y-%m-%dT%H:%M:%SZ"` command to get the current UTC timestamp for the `verified` field.

**Observable Truths section:** Map the 5 success criteria from ROADMAP.md Phase 3:
1. `profile="fast"` applies fast profile config — evidence: `build_run_config` in profiles.py merges fast.yaml; test coverage in test_profiles.py
2. `profile="stealth"` applies stealth profile config — evidence: stealth.yaml exists with anti-bot headers; merge logic applies it
3. Per-call parameter override takes precedence over profile value — evidence: merge order in `build_run_config` (default -> profile -> per-call); tests verify override behavior
4. Claude can call `list_profiles` and see all profiles with full config — evidence: `list_profiles` tool in server.py, registered with `@mcp.tool()`
5. Adding new YAML file to `profiles/` makes it available without code changes — evidence: `ProfileManager._load_all()` uses `Path.glob("*.yaml")`; `list_profiles` docstring documents the mechanism

**CRITICAL: Get current line numbers.** Use `grep -n` or Serena `find_symbol` to find the CURRENT line numbers for these symbols (they have shifted since Phase 3 due to additions in Phases 4-7):
- `ProfileManager` class in profiles.py
- `build_run_config` function in profiles.py
- `list_profiles` tool in server.py
- `crawl_url` function with `profile` parameter in server.py
- `KNOWN_KEYS` and `_PER_CALL_KEYS` constants in profiles.py

**Required Artifacts section:** List these files with existence/content verification:
- `src/crawl4ai_mcp/profiles.py` — contains ProfileManager, build_run_config
- `src/crawl4ai_mcp/profiles/default.yaml` — base layer profile
- `src/crawl4ai_mcp/profiles/fast.yaml` — fast profile (no JS, minimal timeout)
- `src/crawl4ai_mcp/profiles/js_heavy.yaml` — JS-heavy profile (extended wait)
- `src/crawl4ai_mcp/profiles/stealth.yaml` — stealth profile (anti-bot headers)
- `tests/test_profiles.py` — 33 unit tests

**Key Link Verification:** Document at least these wiring connections:
- ProfileManager -> YAML files (glob discovery)
- build_run_config -> CrawlerRunConfig (config construction)
- crawl_url profile param -> build_run_config call
- list_profiles -> ProfileManager.all()
- 5 downstream tools calling build_run_config (crawl_url, create_session, crawl_many, deep_crawl, crawl_sitemap)

**Requirements Coverage section:** Map each requirement to its source plan and evidence:
- PROF-01 -> 03-02-PLAN.md (YAML files created) + 03-01-PLAN.md (ProfileManager loads them)
- PROF-02 -> 03-03-PLAN.md (list_profiles tool)
- PROF-03 -> 03-03-PLAN.md (glob discovery + docstring docs)
- PROF-04 -> 03-01-PLAN.md (build_run_config merge) + 03-02-PLAN.md (crawl_url wiring)

**Anti-Patterns section:** Scan profiles.py, server.py (profile-related code), and profile YAML files for TODO/FIXME/print()/placeholder code. Report findings or "None found."

**IMPORTANT distinction (Pitfall 3 from research):** PROF-01 says "three built-in crawl profiles" — these are fast, js_heavy, and stealth. The `default.yaml` is the base layer, not one of the three. Make this distinction explicit in the verification.
  </action>
  <verify>
Verify the file exists and has correct structure:
- `cat .planning/phases/03-profile-system/03-VERIFICATION.md | head -10` shows YAML frontmatter with `status: passed`
- File contains all 5 sections: Observable Truths, Required Artifacts, Key Link Verification, Requirements Coverage, Anti-Patterns
- All cited line numbers match current source code (spot-check 2-3 references with `grep -n`)
- PROF-01 through PROF-04 all appear in Requirements Coverage with status "Passed"
  </verify>
  <done>03-VERIFICATION.md exists in Phase 3 directory with status: passed, all 5 observable truths verified, all 4 PROF requirements mapped to evidence, all line numbers accurate against current codebase</done>
</task>

<task type="auto">
  <name>Task 2: Update REQUIREMENTS.md traceability and milestone audit</name>
  <files>.planning/REQUIREMENTS.md, .planning/v1.0-MILESTONE-AUDIT.md</files>
  <action>
**REQUIREMENTS.md updates (THREE locations — all must be updated):**

1. **Requirement definition checkboxes (Profiles section):** Change all 4 entries from `- [ ]` to `- [x]`:
   - `- [x] **PROF-01**: Server ships with three built-in crawl profiles...`
   - `- [x] **PROF-02**: User can view all available profiles...`
   - `- [x] **PROF-03**: User can add/edit custom profiles...`
   - `- [x] **PROF-04**: Any crawl tool call can specify a profile name...`

2. **Traceability table:** Change all 4 PROF rows from `Pending` to `Complete`:
   - `| PROF-01 | Phase 3 | Complete |`
   - `| PROF-02 | Phase 3 | Complete |`
   - `| PROF-03 | Phase 3 | Complete |`
   - `| PROF-04 | Phase 3 | Complete |`

3. **Coverage summary:** Update the counts:
   - `Complete: 28` (was 24)
   - Remove or change `Pending (orphaned — needs verification): 4 (PROF-01 through PROF-04)` to `Pending: 0`

**Post-update validation:** Run `grep '\[ \]' .planning/REQUIREMENTS.md` to confirm zero unchecked v1 requirement boxes remain. Run `grep 'Pending' .planning/REQUIREMENTS.md` to confirm no v1 requirements show Pending status.

**Milestone audit update (.planning/v1.0-MILESTONE-AUDIT.md):**
Read the existing file. Update the frontmatter/status to reflect `passed` with 28/28 requirements satisfied. If it has a gap section referencing Phase 3/PROF requirements, mark those gaps as closed. Add a note that Phase 8 closed the gap by producing 03-VERIFICATION.md and updating REQUIREMENTS.md traceability.
  </action>
  <verify>
- `grep -c '\[x\]' .planning/REQUIREMENTS.md` returns 28 (all v1 requirements checked)
- `grep '\[ \]' .planning/REQUIREMENTS.md` returns only v2 requirements (EXTR-V2-*, MULTI-V2-*, AUTH-V2-*, OBS-V2-*) or nothing
- `grep 'Pending' .planning/REQUIREMENTS.md` returns 0 matches in the traceability table (only appears in v2 section if at all)
- `grep 'Complete: 28' .planning/REQUIREMENTS.md` returns a match
- `grep 'status:.*passed' .planning/v1.0-MILESTONE-AUDIT.md` returns a match or equivalent indication
  </verify>
  <done>REQUIREMENTS.md shows 28/28 v1 requirements complete with all PROF checkboxes checked and traceability table updated; milestone audit reflects passed status with 28/28</done>
</task>

</tasks>

<verification>
1. `03-VERIFICATION.md` exists at `.planning/phases/03-profile-system/03-VERIFICATION.md` with `status: passed` frontmatter
2. VERIFICATION.md contains evidence for all 4 PROF requirements with current line numbers
3. REQUIREMENTS.md has 28 checked v1 requirement boxes, 0 Pending v1 requirements in traceability table
4. Milestone audit shows passed status
5. `uv run ruff check src/` still passes (no code changes, but sanity check)
6. `uv run pytest` still passes (no code changes, but sanity check)
</verification>

<success_criteria>
- Phase 3 has a formal VERIFICATION.md confirming PROF-01 through PROF-04
- REQUIREMENTS.md reflects 28/28 v1 requirements complete
- The v1.0 milestone audit gap is closed
- All evidence in VERIFICATION.md is accurate against the current codebase
</success_criteria>

<output>
After completion, create `.planning/phases/08-verify-profiles-traceability/08-01-SUMMARY.md`
</output>
