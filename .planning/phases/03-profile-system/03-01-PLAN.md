---
phase: 03-profile-system
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/crawl4ai_mcp/profiles.py
  - tests/test_profiles.py
autonomous: true
requirements:
  - PROF-03
  - PROF-04

must_haves:
  truths:
    - "ProfileManager loads all *.yaml files from a profiles/ directory at startup"
    - "ProfileManager.get('fast') returns the fast profile dict; ProfileManager.get(None) returns {}"
    - "ProfileManager.get('unknown') returns {} (not an error)"
    - "build_run_config merges default → named profile → per-call overrides (right side wins)"
    - "build_run_config always forces verbose=False regardless of profile content"
    - "build_run_config strips unknown keys (not in KNOWN_KEYS) and logs a warning"
    - "word_count_threshold is popped from the merged dict and routed to PruningContentFilter, not CrawlerRunConfig"
    - "A malformed YAML file is skipped with a logged error — it never crashes ProfileManager.__init__"
  artifacts:
    - path: "src/crawl4ai_mcp/profiles.py"
      provides: "ProfileManager class and build_run_config function"
      exports: ["ProfileManager", "build_run_config", "PROFILES_DIR", "KNOWN_KEYS"]
    - path: "tests/test_profiles.py"
      provides: "TDD test suite for merge logic and ProfileManager"
      min_lines: 60
  key_links:
    - from: "src/crawl4ai_mcp/profiles.py"
      to: "crawl4ai.CrawlerRunConfig"
      via: "build_run_config constructs CrawlerRunConfig from merged dict"
      pattern: "CrawlerRunConfig\\(\\*\\*merged\\)"
    - from: "src/crawl4ai_mcp/profiles.py"
      to: "crawl4ai.content_filter_strategy.PruningContentFilter"
      via: "build_run_config pops word_count_threshold and passes to PruningContentFilter"
      pattern: "word_count_threshold.*merged\\.pop"
---

<objective>
Implement ProfileManager and build_run_config using TDD. These are the two core units of the profile system — pure Python logic with well-defined inputs and outputs, making them ideal TDD candidates.

Purpose: Establish the merge engine and profile loader that all other Phase 3 work depends on. Getting the merge order and verbose=False enforcement correct here prevents subtle bugs that would corrupt MCP transport later.
Output: `src/crawl4ai_mcp/profiles.py` (ProfileManager class + build_run_config function) backed by a passing test suite.
</objective>

<execution_context>
@/Users/brianpotter/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianpotter/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-profile-system/03-RESEARCH.md
@src/crawl4ai_mcp/server.py
</context>

<feature>
  <name>ProfileManager + build_run_config</name>
  <files>src/crawl4ai_mcp/profiles.py, tests/test_profiles.py</files>

  <behavior>
ProfileManager:
- __init__(profiles_dir: Path) — loads all *.yaml files from the directory at construction time
- get(name: str | None) -> dict — returns a copy of the named profile dict; returns {} if name is None or not found
- all() -> dict[str, dict] — returns copy of the full profile registry
- names property -> list[str] — sorted profile names
- Bad YAML (syntax error, non-dict root, IOError) logs error to stderr and is skipped; __init__ never raises

build_run_config(profile_manager, profile, **per_call_overrides) -> CrawlerRunConfig:
- Merge order: default_profile <- named_profile <- per_call_overrides (right wins)
- verbose=False forced unconditionally after merge (before constructing CrawlerRunConfig)
- word_count_threshold is popped from merged dict and used in PruningContentFilter (default 10 if absent)
- Unknown keys (not in KNOWN_KEYS) are stripped with a warning log; they do not reach CrawlerRunConfig(**merged)
- markdown_generator is constructed from the popped word_count_threshold and added to merged before CrawlerRunConfig(**merged)
- Returns a CrawlerRunConfig instance

Input/output cases for build_run_config:
- (pm, None, **{}) -> uses only default profile, verbose=False guaranteed
- (pm, "fast", **{}) -> default merged with fast profile
- (pm, "fast", page_timeout=5000) -> default + fast, then page_timeout overridden to 5000
- (pm, "nonexistent", **{}) -> logs warning, falls back to default only
- (pm, "stealth", verbose=True) -> verbose forced to False in output CrawlerRunConfig
  </behavior>

  <implementation>
Create src/crawl4ai_mcp/profiles.py with:

1. PROFILES_DIR = Path(__file__).parent / "profiles"

2. KNOWN_KEYS set containing all CrawlerRunConfig kwargs that profiles may set:
   {"wait_until", "page_timeout", "delay_before_return_html", "simulate_user",
    "override_navigator", "magic", "scan_full_page", "scroll_delay",
    "remove_overlay_elements", "word_count_threshold", "cache_mode",
    "mean_delay", "max_range"}
   NOTE: "verbose" is intentionally excluded — it is handled separately and unconditionally.

3. ProfileManager class:
   - _profiles: dict[str, dict] — internal registry
   - _load_all(profiles_dir: Path) — iterates sorted(profiles_dir.glob("*.yaml")), wraps each load in try/except Exception
   - get(name) — returns dict(self._profiles.get(name or "", {}))
   - all() — returns dict(self._profiles)
   - names property

4. build_run_config(profile_manager, profile, **per_call_overrides) -> CrawlerRunConfig:
   - default = profile_manager.get("default")
   - named = profile_manager.get(profile) if profile else {}
   - If profile is not None and profile not in profile_manager.names, log a warning
   - merged = {**default, **named, **per_call_overrides}
   - unknown = set(merged.keys()) - KNOWN_KEYS - {"cache_mode", "css_selector", "excluded_selector", "wait_for", "js_code", "user_agent"}
     (NOTE: css_selector, excluded_selector, wait_for, js_code, user_agent are per-call params, not YAML profile keys, but are valid CrawlerRunConfig kwargs — include them in the full valid-keys set used when checking per_call_overrides)
   - Strip unknown keys with logger.warning
   - Force merged["verbose"] = False
   - wct = merged.pop("word_count_threshold", 10)
   - merged["markdown_generator"] = DefaultMarkdownGenerator(content_filter=PruningContentFilter(threshold=0.48, threshold_type="fixed", min_word_threshold=wct))
   - return CrawlerRunConfig(**merged)

   IMPORTANT: The full set of valid CrawlerRunConfig kwargs (for unknown-key detection) is:
   KNOWN_KEYS | {"css_selector", "excluded_selector", "wait_for", "js_code", "user_agent", "cache_mode"}
   This allows per-call params like css_selector to pass through without triggering unknown-key warnings.

Create tests/test_profiles.py using pytest with tmp_path fixture for YAML file creation.
Test cases must include:
- ProfileManager loads files from tmp dir, get() returns correct dict
- ProfileManager.get(None) returns {}
- ProfileManager.get("missing") returns {}
- Malformed YAML file is skipped, other profiles still load
- build_run_config with profile=None uses only default
- build_run_config with profile="fast" merges default + fast (fast values win over default on collision)
- build_run_config per-call override wins over profile value
- build_run_config always returns CrawlerRunConfig with verbose=False
- build_run_config with unknown key in profile: key stripped, warning logged, no TypeError from CrawlerRunConfig
- word_count_threshold from profile flows to PruningContentFilter (check markdown_generator is not None)
  </implementation>
</feature>

<verification>
RED phase: `uv run pytest tests/test_profiles.py` — all tests FAIL (profiles.py not yet written or stubs only)
GREEN phase: `uv run pytest tests/test_profiles.py` — all tests PASS
Lint: `uv run ruff check src/` — no T201 (print) violations
Import sanity: `uv run python -c "from crawl4ai_mcp.profiles import ProfileManager, build_run_config; print('ok')"` — prints "ok"
</verification>

<success_criteria>
- tests/test_profiles.py exists with >= 10 test cases covering merge order, verbose enforcement, unknown-key stripping, and malformed YAML resilience
- All tests pass: `uv run pytest tests/test_profiles.py -v`
- profiles.py exports: ProfileManager, build_run_config, PROFILES_DIR, KNOWN_KEYS
- No ruff lint errors in src/
</success_criteria>

<output>
After completion, create `.planning/phases/03-profile-system/03-01-SUMMARY.md` following the summary template.
</output>
