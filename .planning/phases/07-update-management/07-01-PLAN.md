---
phase: 07-update-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/crawl4ai_mcp/server.py
  - tests/test_update.py
autonomous: true
requirements:
  - UPDT-01
  - UPDT-02

must_haves:
  truths:
    - "Claude can call check_update and see installed version, latest PyPI version, and whether an update is available"
    - "check_update returns changelog highlights when an update is available"
    - "check_update returns a structured error message when PyPI is unreachable (never crashes)"
    - "Server logs a stderr warning on startup when a newer crawl4ai version exists on PyPI"
    - "Startup version check never blocks server from becoming ready (fire-and-forget)"
    - "check_update never performs an upgrade — it only reports"
  artifacts:
    - path: "src/crawl4ai_mcp/server.py"
      provides: "check_update MCP tool, _get_latest_pypi_version helper, _fetch_changelog_summary helper, _startup_version_check background task"
      contains: "async def check_update"
    - path: "tests/test_update.py"
      provides: "Unit tests for version check logic"
  key_links:
    - from: "src/crawl4ai_mcp/server.py (check_update)"
      to: "https://pypi.org/pypi/crawl4ai/json"
      via: "httpx.AsyncClient GET request"
      pattern: "httpx\\.AsyncClient.*pypi\\.org"
    - from: "src/crawl4ai_mcp/server.py (check_update)"
      to: "importlib.metadata"
      via: "importlib.metadata.version('crawl4ai')"
      pattern: "importlib\\.metadata\\.version"
    - from: "src/crawl4ai_mcp/server.py (app_lifespan)"
      to: "_startup_version_check"
      via: "asyncio.create_task (fire-and-forget)"
      pattern: "create_task.*_startup_version_check"
---

<objective>
Add a `check_update` MCP tool that lets Claude check for crawl4ai updates mid-session, plus a non-blocking startup version check that warns to stderr when the server is outdated.

Purpose: Claude should be able to proactively check for updates without leaving the session, and operators should see a visible warning when running an outdated version.
Output: `check_update` tool registered in MCP, startup warning logged to stderr, unit tests for version check logic.
</objective>

<execution_context>
@/Users/brianpotter/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianpotter/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-update-management/07-RESEARCH.md
@src/crawl4ai_mcp/server.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add check_update tool, helpers, and startup version check</name>
  <files>src/crawl4ai_mcp/server.py</files>
  <action>
Add these components to `server.py`:

**1. New imports (near top, after existing imports):**
```python
import importlib.metadata
from packaging.version import Version
```
`httpx` and `asyncio` are already imported.

**2. Helper: `_get_latest_pypi_version`**
Async function that queries `https://pypi.org/pypi/crawl4ai/json` via `httpx.AsyncClient(timeout=10.0)`. Returns a tuple `(version_string, full_json_data)`. Raises on HTTP error or timeout (caller handles).

**3. Helper: `_fetch_changelog_summary`**
Async function that fetches `https://raw.githubusercontent.com/unclecode/crawl4ai/main/CHANGELOG.md` via httpx. Extracts the section for a given version using regex pattern `## \[{version}\].*?\n(.*?)(?=\n## \[|$)` with `re.DOTALL`. Returns category headers (`### `) and first-level bullets (`- **`) truncated to 20 lines. On any failure, returns a fallback URL string `"Changelog: https://github.com/unclecode/crawl4ai/blob/main/CHANGELOG.md"`.

**4. MCP tool: `check_update`**
Register as `@mcp.tool()`. Takes only `ctx: Context[ServerSession, AppContext]`. Docstring: "Check if a newer version of crawl4ai is available on PyPI. Compares the installed version against the latest release. Reports version info and changelog highlights. Never performs the upgrade itself -- use scripts/update.sh for that."

Logic:
- Get installed version via `importlib.metadata.version("crawl4ai")`
- Call `_get_latest_pypi_version()` wrapped in try/except for `httpx.HTTPError`, `httpx.TimeoutException` — on failure return structured error with installed version and error message
- Compare using `packaging.version.Version`
- If up-to-date: return "crawl4ai is up to date\nInstalled: {installed}\nLatest: {latest}"
- If update available: call `_fetch_changelog_summary(latest)`, return multi-line string with installed, latest, release URL (`https://github.com/unclecode/crawl4ai/releases/tag/v{latest}`), update instructions ("stop the server and run: scripts/update.sh"), and changelog summary

Place the tool near other admin tools (after `list_profiles`, before `crawl_url`). Follow the structured error return pattern — never raise exceptions from the tool.

**5. Background startup check: `_startup_version_check`**
Async function. Uses the same `_get_latest_pypi_version` logic but with a tighter timeout (5s). If `Version(latest) > Version(installed)`, calls `logger.warning()` with message: "A newer crawl4ai version is available: %s (installed: %s). Run scripts/update.sh to upgrade."

Wrap the entire function body in `try/except Exception: pass` — version checking must NEVER disrupt server startup.

**6. Wire startup check into `app_lifespan`**
After `logger.info("Browser ready ...")` and before the `try: yield app_ctx` block, add:
```python
asyncio.create_task(_startup_version_check())
```

This fires the check concurrently without blocking the server from accepting tool calls.

**Critical constraints:**
- Never `print()` anything — all output via `logger` to stderr
- Never call pip/uv install — tool only reports
- The startup check must be fire-and-forget (create_task, not await)
- httpx clients must be created and closed within each function (no persistent client)
  </action>
  <verify>
`uv run ruff check src/` passes with no errors (especially T201 for print calls).
`uv run python -c "from crawl4ai_mcp.server import mcp; print('import ok')"` succeeds.
Verify that `check_update` appears in the tool list by inspecting the source.
  </verify>
  <done>
check_update tool is registered, _get_latest_pypi_version and _fetch_changelog_summary helpers exist, _startup_version_check is wired into app_lifespan via asyncio.create_task. No print() calls, no in-process upgrades.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add unit tests for version check logic</name>
  <files>tests/test_update.py</files>
  <action>
Create `tests/test_update.py` with unit tests that mock external HTTP calls. Use `pytest` and `unittest.mock` (AsyncMock, patch).

**Tests to write:**

1. **test_check_update_up_to_date** — Mock `importlib.metadata.version` to return "0.8.0", mock httpx response to return PyPI JSON with `info.version` = "0.8.0". Assert tool returns string containing "up to date" and "0.8.0".

2. **test_check_update_available** — Mock installed as "0.8.0", PyPI latest as "0.9.0". Mock changelog fetch to return a fake changelog. Assert result contains "Update available", "0.8.0", "0.9.0", "scripts/update.sh", and changelog content.

3. **test_check_update_pypi_unreachable** — Mock httpx to raise `httpx.ConnectError`. Assert result contains "Version check failed", installed version, and error message. Assert it does NOT raise an exception.

4. **test_check_update_pypi_timeout** — Mock httpx to raise `httpx.TimeoutException`. Assert structured error returned, not exception.

5. **test_fetch_changelog_summary_success** — Call `_fetch_changelog_summary` with mock response containing a valid Keep a Changelog section. Assert extracted headers and bullets appear in result.

6. **test_fetch_changelog_summary_fallback** — Mock httpx to raise. Assert fallback URL string is returned.

7. **test_startup_version_check_logs_warning** — Mock installed as "0.8.0", PyPI as "0.9.0". Call `_startup_version_check()` directly. Assert `logger.warning` was called with the update message.

8. **test_startup_version_check_no_warning_when_current** — Mock installed as "0.8.0", PyPI as "0.8.0". Assert `logger.warning` was NOT called.

9. **test_startup_version_check_swallows_exceptions** — Mock httpx to raise. Assert no exception propagates (function completes silently).

**Mocking pattern:**
- Patch `importlib.metadata.version` to control installed version
- Patch `httpx.AsyncClient` with an AsyncMock whose `get()` returns a mock response object with `.json()` returning the PyPI data dict and `.raise_for_status()` doing nothing
- Patch the logger to verify warning calls

All tests should be async (`@pytest.mark.asyncio`). Import helpers directly from `crawl4ai_mcp.server` (they are module-level functions).
  </action>
  <verify>
`uv run pytest tests/test_update.py -v` — all 9 tests pass.
`uv run pytest` — full test suite still passes (no regressions).
  </verify>
  <done>
9 unit tests cover: up-to-date, update available, PyPI unreachable, PyPI timeout, changelog success, changelog fallback, startup warning logged, startup no warning, startup swallows exceptions. All pass. Full test suite has no regressions.
  </done>
</task>

</tasks>

<verification>
1. `uv run ruff check src/` — no lint errors, no T201 (print) violations
2. `uv run pytest tests/test_update.py -v` — all 9 tests pass
3. `uv run pytest` — full test suite passes (no regressions)
4. Confirm `check_update` is in the MCP tool list via import check
5. Confirm `_startup_version_check` is called via `asyncio.create_task` in `app_lifespan`
</verification>

<success_criteria>
- check_update tool returns version comparison for all outcomes (up-to-date, update available, error)
- Startup version check logs warning to stderr without blocking server readiness
- No print() calls, no in-process pip/uv calls
- 9 unit tests pass covering all code paths
</success_criteria>

<output>
After completion, create `.planning/phases/07-update-management/07-01-SUMMARY.md`
</output>
