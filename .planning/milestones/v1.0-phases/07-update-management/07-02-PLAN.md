---
phase: 07-update-management
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/update.sh
autonomous: true
requirements:
  - UPDT-03

must_haves:
  truths:
    - "Running scripts/update.sh upgrades crawl4ai to the latest version within pyproject.toml constraints"
    - "scripts/update.sh re-installs Playwright browser after upgrading crawl4ai"
    - "scripts/update.sh runs a smoke test confirming crawl4ai imports correctly after upgrade"
    - "scripts/update.sh reports current and new version, and prints clear instructions if already at latest"
    - "scripts/update.sh detects when the latest PyPI version exceeds the pyproject.toml pin range and warns the user"
  artifacts:
    - path: "scripts/update.sh"
      provides: "Offline crawl4ai upgrade script with Playwright reinstall and smoke test"
  key_links:
    - from: "scripts/update.sh"
      to: "pyproject.toml"
      via: "uv lock --upgrade-package reads version constraints"
      pattern: "uv lock --upgrade-package crawl4ai"
    - from: "scripts/update.sh"
      to: "crawl4ai-setup"
      via: "uv run crawl4ai-setup for Playwright browser install"
      pattern: "uv run crawl4ai-setup"
---

<objective>
Create a `scripts/update.sh` shell script that safely upgrades crawl4ai offline, re-installs Playwright if needed, and confirms the server still works.

Purpose: Upgrades must happen outside the running server process. The script provides a safe, repeatable one-command upgrade path.
Output: Executable `scripts/update.sh` ready for use.
</objective>

<execution_context>
@/Users/brianpotter/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianpotter/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-update-management/07-RESEARCH.md
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create scripts/update.sh</name>
  <files>scripts/update.sh</files>
  <action>
Create the `scripts/` directory and `scripts/update.sh` file.

**Script requirements:**

1. **Shebang and safety:** `#!/usr/bin/env bash` with `set -euo pipefail` for strict error handling.

2. **Directory resolution:** Resolve `SCRIPT_DIR` and `PROJECT_DIR` using `$(cd "$(dirname "$0")" && pwd)` and `$(dirname "$SCRIPT_DIR")`. `cd "$PROJECT_DIR"` to ensure uv commands run in the project root.

3. **Show current version:**
```bash
CURRENT=$(uv run python -c "import importlib.metadata; print(importlib.metadata.version('crawl4ai'))")
echo "Current version: $CURRENT"
```

4. **Check PyPI for latest available version:**
```bash
LATEST=$(uv run python -c "
import httpx, json
resp = httpx.get('https://pypi.org/pypi/crawl4ai/json', timeout=10.0)
resp.raise_for_status()
print(resp.json()['info']['version'])
")
echo "Latest on PyPI: $LATEST"
```

5. **Compare current vs latest — if already at latest, exit early with informative message:**
```bash
if [ "$CURRENT" = "$LATEST" ]; then
    echo ""
    echo "Already at latest version ($CURRENT)."
    exit 0
fi
```

6. **Upgrade crawl4ai within pyproject.toml constraints:**
```bash
echo ""
echo "Upgrading crawl4ai..."
uv lock --upgrade-package crawl4ai
uv sync
```

7. **Show new installed version:**
```bash
NEW=$(uv run python -c "import importlib.metadata; print(importlib.metadata.version('crawl4ai'))")
echo "New version: $NEW"
```

8. **Detect pin range block:** If `$NEW` equals `$CURRENT` but `$LATEST` is different, the pyproject.toml version constraint is blocking the upgrade. Print a clear warning:
```
NOTE: Latest version ($LATEST) exceeds your pyproject.toml version constraint.
To upgrade beyond the current pin, edit pyproject.toml and widen the crawl4ai version range,
then re-run this script.
```
Exit 0 (not an error).

9. **Reinstall Playwright browser (only if version actually changed):**
```bash
echo ""
echo "Reinstalling Playwright browser..."
uv run crawl4ai-setup
```

10. **Smoke test:**
```bash
echo ""
echo "Running smoke test..."
uv run python -c "
import crawl4ai
print(f'crawl4ai {crawl4ai.__version__} imported successfully')
from crawl4ai import AsyncWebCrawler, BrowserConfig
print('Core imports OK')
"
```

11. **Final message:**
```
=== Update complete: $CURRENT -> $NEW ===
Restart the MCP server for changes to take effect.
```

After creating the file, make it executable: `chmod +x scripts/update.sh`

**Critical constraints:**
- Script must be idempotent — running when already up-to-date is harmless
- Never auto-edit pyproject.toml — only warn if pin range blocks upgrade
- set -euo pipefail ensures script stops on first error
- All output goes to stdout/stderr (this is a CLI script, not MCP)
  </action>
  <verify>
`bash -n scripts/update.sh` — syntax check passes (no parse errors).
`ls -la scripts/update.sh` confirms the file is executable.
`head -1 scripts/update.sh` shows `#!/usr/bin/env bash`.
`grep 'set -euo pipefail' scripts/update.sh` confirms strict mode.
`grep 'uv run crawl4ai-setup' scripts/update.sh` confirms Playwright reinstall step.
`grep 'smoke test' scripts/update.sh` confirms smoke test step.
  </verify>
  <done>
scripts/update.sh exists, is executable, performs: version display, uv upgrade, pin-range detection with warning, Playwright reinstall, smoke test, final status message. Idempotent and safe.
  </done>
</task>

</tasks>

<verification>
1. `bash -n scripts/update.sh` — no syntax errors
2. `ls -la scripts/update.sh` — executable bit set
3. Script contains all required steps: version check, upgrade, pin detection, Playwright reinstall, smoke test
4. `set -euo pipefail` present for strict error handling
</verification>

<success_criteria>
- scripts/update.sh exists and is executable
- Script performs uv upgrade, Playwright reinstall, and smoke test
- Script detects and warns about pin range blocks
- Script is idempotent (safe to run when already at latest)
</success_criteria>

<output>
After completion, create `.planning/phases/07-update-management/07-02-SUMMARY.md`
</output>
